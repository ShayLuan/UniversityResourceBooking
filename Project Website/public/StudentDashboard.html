<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;600;700&display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Exo+2:ital,wght@0,100..900;1,100..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="StudentDashboard.css" />
</head>

<body class="student">
  <nav class="sidebar">
    <a href="" class="sidebar-link" id="messagesLink"><span>ðŸ’¬</span> Messages<span id="notification-badge" class="notification-badge" style="display: none;"><img src="sourcePics/transparent_speech_bubble.png" alt="New" /></span></a>
    <a href="ResourcesLogin.html" class="sidebar-link"><span>ðŸ“–</span> Browse Resources</a>
    <a href="MyBookings.html" class="sidebar-link"><span>ðŸ“…</span>My Bookings</a>
    <a href="Login.html" class="sidebar-link"><span>ðŸšª</span> Log out</a>
  </nav>
  <div class="main">
    <h1 id="welcome-message">Welcome, Dear Student!</h1>
    
    <!-- messages modal -->
    <div id="messages-modal" style="display: none;">
      <div class="messages-bubble">
        <div class="bubble-content">
          <h3>Messages</h3>
          <div id="messages-container">
            <p style="text-align: center; color: #666; padding: 20px;">Loading messages...</p>
          </div>
          <div class="messages-buttons">
            <button class="button" id="close-messages-btn">Close</button>
          </div>
        </div>
        <div class="bubble-tail"></div>
      </div>
    </div>
    <div class="card-grid">
      <a href="ResourceSpotlight.html" class="card-link">
        <div class="card">
          <h2>Resource Spotlight</h2>
          <p>Track current availability and booking times.</p>
        </div>
      </a>

      <a href="ManageMyAccount.html" class="card-link">
        <div class="card">
          <h2>Manage My Account</h2>
          <p>Update personal details and contact information.</p>
        </div>
      </a>

      <a href="mailto:support@campusbooker.edu" class="card-link">
        <div class="card">
          <h2>Contact an Admin</h2>
          <p>
            Get helpful support or assistance from our responsive
            administrator team.
          </p>
        </div>
      </a>

      <a href="booking-form.html" class="card-link">
        <div class="card">
          <h2>Book a Resource</h2>
          <p>
            Reserve study rooms, equipment, or other campus resources in just
            a few clicks.
          </p>
        </div>
      </a>

      <a href="bookingHistory.html" class="card-link" id="booking-history">
        <div class="card">
          <h2>Booking History</h2>
          <p>
            A record of all past bookings.
          </p>
          <p>
            For ongoing bookings, click on My Bookings in the sidebar.
          </p>
        </div>
      </a>
    </div>
  </div>
  <script>
    // load user name and update welcome message
    async function loadUserName() {
      try {
        const res = await fetch("/api/user", { credentials: "include" });
        if (!res.ok) {
          console.error("Failed to load user data");
          return;
        }
        
        const user = await res.json();
        if (user.name) {
          // just keep the first word for the msg
          const firstName = user.name.split(' ')[0];
          const welcomeElement = document.getElementById("welcome-message");
          if (welcomeElement) {
            welcomeElement.textContent = `Welcome, ${firstName}!`;
          }
        }
      } catch (err) {
        console.error("Error loading user data:", err);
      }
    }

    // Load messages
    async function loadMessages() {
      try {
        const response = await fetch('/api/announcements', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Failed to load messages');
        }
        
        const announcements = await response.json();
        const container = document.getElementById('messages-container');
        
        if (announcements.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No messages yet.</p>';
          return;
        }
        
        container.innerHTML = '';
        announcements.forEach(announcement => {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message-item';
          
          const date = new Date(announcement.created_at);
          const formattedDate = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          messageDiv.innerHTML = `
            <div class="message-header">
              <strong>From: ${announcement.admin_name || 'Administrator'}</strong>
              <span class="message-date">${formattedDate}</span>
            </div>
            <div class="message-text">${announcement.message}</div>
          `;
          
          container.appendChild(messageDiv);
        });
        
        // hide notification badge when messages are loaded
        const badge = document.getElementById('notification-badge');
        if (badge) {
          badge.style.display = 'none';
        }
        // Store last viewed time
        if (announcements.length > 0) {
          const latestAnnouncement = announcements[0];
          localStorage.setItem('lastViewedAnnouncement', latestAnnouncement.created_at);
        }
      } catch (err) {
        console.error('Error loading messages:', err);
        document.getElementById('messages-container').innerHTML = 
          '<p style="text-align: center; color: #c1121f; padding: 20px;">Error loading messages. Please try again.</p>';
      }
    }
    
    // check for new notifications
    async function checkForNewNotifications() {
      try {
        const response = await fetch('/api/announcements', { credentials: 'include' });
        if (!response.ok) {
          return;
        }
        
        const announcements = await response.json();
        if (announcements.length === 0) {
          return;
        }
        
        const latestAnnouncement = announcements[0];
        const lastViewed = localStorage.getItem('lastViewedAnnouncement');
        const badge = document.getElementById('notification-badge');
        
        // Show badge if there's no last viewed time, or if there's a newer announcement
        if (!lastViewed || new Date(latestAnnouncement.created_at) > new Date(lastViewed)) {
          if (badge) {
            badge.style.display = 'inline-block';
          }
        } else {
          if (badge) {
            badge.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('Error checking for notifications:', err);
      }
    }
    
    // messages button click handler
    document.getElementById('messagesLink').addEventListener('click', function (event) {
      event.preventDefault();
      const modal = document.getElementById('messages-modal');
      modal.style.display = 'flex';
      loadMessages();
    });
    
    // close
    document.getElementById('close-messages-btn').addEventListener('click', function () {
      document.getElementById('messages-modal').style.display = 'none';
    });
    
    // close when clicking outside
    document.getElementById('messages-modal').addEventListener('click', function (event) {
      if (event.target === this) {
        this.style.display = 'none';
      }
    });

    // Load user name when page loads
    document.addEventListener("DOMContentLoaded", () => {
      loadUserName();
      checkForNewNotifications();
      
    //   // Booking history click handler
    //   document.getElementById('booking-history').addEventListener('click', function () {
    //     window.open('BookingHistory.html', '_blank', 'width=900,height=600');
    //   });

    });
  </script>
</body>

</html>